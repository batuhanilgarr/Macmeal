<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Beslenme ve Spor Günlüğü</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0b0f14; --panel:#121821; --muted:#94a3b8; --text:#e6edf3; --accent:#22c55e; --accent-2:#06b6d4; --danger:#ef4444; }
    :root.light { --bg:#f8fafc; --panel:#ffffff; --muted:#64748b; --text:#1e293b; --accent:#16a34a; --accent-2:#0891b2; --danger:#dc2626; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--text); background:linear-gradient(180deg,#06090f, #0b1220); }
    body.light{ background:linear-gradient(180deg,#f1f5f9, #e2e8f0); }
    .container{ max-width:980px; margin:0 auto; padding:24px; }
    @media (max-width: 640px) { .container{ padding:16px; } }
    .header{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:18px; }
    @media (max-width: 640px) { .header{ flex-direction:column; gap:8px; align-items:stretch; } }
    .title{ font-weight:700; letter-spacing:.2px; font-size:22px; }
    .sub{ color:var(--muted); font-size:12px }
    .row{ display:flex; flex-wrap:wrap; gap:16px; }
    @media (max-width: 640px) { .row{ gap:12px; } }
    .card{ flex:1 1 320px; background:rgba(16,22,31,.75); border:1px solid rgba(148,163,184,.15); border-radius:14px; padding:16px; backdrop-filter: blur(8px); }
    .card.light{ background:rgba(255,255,255,.9); border-color:rgba(148,163,184,.25); }
    @media (max-width: 640px) { .card{ padding:12px; } }
    .card h3{ margin:0 0 12px; font-size:16px }
    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px }
    input, select, textarea{ width:100%; background:#0c121a; color:var(--text); border:1px solid rgba(148,163,184,.2); border-radius:10px; padding:10px 12px; outline:none; font:inherit }
    input.light, select.light, textarea.light{ background:#f8fafc; border-color:rgba(148,163,184,.3); }
    @media (max-width: 640px) { input, select, textarea{ padding:12px; font-size:16px; } }
    textarea{ min-height:84px; resize:vertical }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    @media (max-width: 640px) { .grid-2{ grid-template-columns:1fr; gap:8px; } }
    .actions{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap }
    @media (max-width: 640px) { .actions{ gap:8px; } }
    button{ background:linear-gradient(180deg,#1e293b,#111827); color:var(--text); border:1px solid rgba(148,163,184,.25); border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:600 }
    button.light{ background:linear-gradient(180deg,#f1f5f9,#e2e8f0); border-color:rgba(148,163,184,.3); }
    @media (max-width: 640px) { button{ padding:12px 16px; font-size:16px; } }
    button.primary{ background:linear-gradient(180deg,#22c55e,#16a34a); border-color:#16a34a; color:#04120a }
    button.primary.light{ background:linear-gradient(180deg,#16a34a,#15803d); color:#ffffff; }
    button.alt{ background:linear-gradient(180deg,#06b6d4,#0891b2); border-color:#0891b2; color:#021015 }
    button.alt.light{ background:linear-gradient(180deg,#0891b2,#0e7490); color:#ffffff; }
    button.danger{ background:linear-gradient(180deg,#ef4444,#b91c1c); border-color:#b91c1c; color:#220404 }
    button.danger.light{ background:linear-gradient(180deg,#dc2626,#b91c1c); color:#ffffff; }
    .list{ margin-top:8px; display:flex; flex-direction:column; gap:8px; max-height:260px; overflow:auto }
    .item{ border:1px solid rgba(148,163,184,.18); background:rgba(11,17,24,.65); border-radius:12px; padding:10px 12px; display:flex; justify-content:space-between; gap:12px }
    .item.light{ background:rgba(248,250,252,.8); border-color:rgba(148,163,184,.25); }
    @media (max-width: 640px) { .item{ padding:12px; } }
    .item small{ color:var(--muted) }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:700; letter-spacing:.2px }
    .pill.sabah{ background:#0b3b1d; color:#86efac; border:1px solid #14532d }
    .pill.oglen{ background:#083344; color:#67e8f9; border:1px solid #164e63 }
    .pill.aksam{ background:#3b0764; color:#d8b4fe; border:1px solid #581c87 }
    .pill.ekstra{ background:#1e293b; color:#cbd5e1; border:1px solid #334155 }
    .footer{ display:flex; justify-content:space-between; gap:10px; margin-top:16px; align-items:center }
    @media (max-width: 640px) { .footer{ flex-direction:column; gap:8px; align-items:stretch; } }
    .muted{ color:var(--muted); font-size:12px }
    .section-title{ display:flex; align-items:center; justify-content:space-between; gap:8px }
    .empty{ color:var(--muted); font-size:13px; padding:8px 0 }
    .item-actions{ display:flex; gap:8px; align-items:center }
    @media (max-width: 640px) { .item-actions{ gap:6px; } }
    .btn-sm{ padding:6px 8px; font-size:12px; border-radius:8px }
    @media (max-width: 640px) { .btn-sm{ padding:8px 10px; font-size:14px; } }
    .btn-ghost{ background:transparent; border:1px solid rgba(148,163,184,.25) }
    .btn-edit{ border-color:#0891b2; color:#67e8f9 }
    .btn-del{ border-color:#b91c1c; color:#fecaca }

    /* Toast */
    .toast{ position:fixed; top:20px; right:20px; z-index:1000; background:var(--panel); border:1px solid rgba(148,163,184,.2); border-radius:12px; padding:12px 16px; box-shadow:0 4px 12px rgba(0,0,0,.15); max-width:320px; }
    .toast.light{ border-color:rgba(148,163,184,.3); }
    @media (max-width: 640px) { .toast{ top:10px; right:10px; left:10px; max-width:none; } }
    .toast.success{ border-left:4px solid var(--accent); }
    .toast.error{ border-left:4px solid var(--danger); }
    .toast-content{ display:flex; align-items:center; gap:8px; }
    .toast-undo{ margin-left:auto; padding:4px 8px; background:transparent; border:1px solid var(--accent); border-radius:6px; color:var(--accent); font-size:12px; cursor:pointer; }
    .toast-undo:hover{ background:var(--accent); color:var(--panel); }

    /* Theme toggle */
    .theme-toggle{ position:fixed; top:20px; left:20px; z-index:1000; background:var(--panel); border:1px solid rgba(148,163,184,.2); border-radius:50%; width:48px; height:48px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.1); }
    .theme-toggle.light{ border-color:rgba(148,163,184,.3); }
    @media (max-width: 640px) { .theme-toggle{ top:10px; left:10px; width:44px; height:44px; } }
  </style>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" defer></script>
  <!-- jsPDF & autotable for export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js" defer></script>
</head>
<body>
  <div class="theme-toggle" id="theme-toggle">🌙</div>
  <div class="container">
    <div class="header">
      <div>
        <div class="title">Beslenme ve Spor Günlüğü</div>
        <div class="sub">Günlük öğünler, ekstra tüketimler, spor hareketleri ve PDF çıktı</div>
      </div>
      <div class="grid-2" style="min-width:260px; max-width:360px; align-items:center">
        <div>
          <label for="date">Tarih</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label for="time">Saat</label>
          <input id="time" type="time" />
        </div>
      </div>
    </div>

    <div class="row">
      <div class="card" id="meal-card">
        <div class="section-title">
          <h3>Öğün Ekle (Otomatik: Sabah / Öğle / Akşam)</h3>
          <span id="autoMealType" class="pill">-</span>
        </div>
        <div class="grid-2">
          <div>
            <label for="meal-name">Yemek İsmi</label>
            <input id="meal-name" placeholder="Ör. Yulaf, Omlet" />
          </div>
          <div>
            <label for="meal-amount">Miktar</label>
            <input id="meal-amount" placeholder="Ör. 2 dilim, 200 g, 1 kase" />
          </div>
        </div>
        <div class="actions">
          <button class="primary" id="add-meal">Öğün Kaydet</button>
        </div>
        <div class="list" id="meals-list"></div>
      </div>

      <div class="card" id="extra-card">
        <div class="section-title">
          <h3>Ekstra (Su ve Diğer Tüketimler)</h3>
          <span class="pill ekstra">EKSTRA</span>
        </div>
        <div class="grid-2">
          <div>
            <label for="extra-name">Ürün / İçecek</label>
            <input id="extra-name" placeholder="Ör. Su, Kahve, Atıştırmalık" />
          </div>
          <div>
            <label for="extra-amount">Miktar</label>
            <input id="extra-amount" placeholder="Ör. 500 ml, 1 fincan" />
          </div>
        </div>
        <div class="actions">
          <button class="primary" id="add-extra">Ekstra Kaydet</button>
        </div>
        <div class="list" id="extras-list"></div>
      </div>
    </div>

    <div class="row" style="margin-top:16px">
      <div class="card" id="workout-card">
        <div class="section-title">
          <h3>Spor Hareketleri</h3>
          <span class="pill" style="background:#2e1065; color:#c4b5fd; border:1px solid #4c1d95">SPOR</span>
        </div>
        <div class="grid-2">
          <div>
            <label for="workout-name">Hareket</label>
            <input id="workout-name" placeholder="Ör. Şınav, Squat, Koşu" />
          </div>
          <div>
            <label for="workout-reps">Süre / Tekrar</label>
            <input id="workout-reps" placeholder="Ör. 3x12, 30 dk" />
          </div>
        </div>
        <label for="workout-notes">Not</label>
        <textarea id="workout-notes" placeholder="Ör. Sağ dizde hafif ağrı"></textarea>
        <div class="actions">
          <button class="primary" id="add-workout">Sporu Kaydet</button>
        </div>
        <div class="list" id="workouts-list"></div>
      </div>
    </div>

    <div class="footer">
      <div class="muted">Veriler cihazında ve Supabase üzerinde gün bazlı tutulur.</div>
      <div class="actions">
        <button class="alt" id="export-pdf">Bugünü PDF Kaydet</button>
        <button class="danger" id="clear-day">Bugünü Temizle</button>
      </div>
    </div>
    <div class="row" style="margin-top:16px">
      <div class="card" id="fixed-meal-plan">
        <div class="section-title">
          <h3>Beslenme Programım (Sabit)</h3>
          <span class="pill" style="background:#0b3b1d; color:#86efac; border:1px solid #14532d">PLAN</span>
        </div>
        <div class="grid-2">
          <div>
            <label for="plan-meal-name">Yemek/Öğe</label>
            <input id="plan-meal-name" placeholder="Ör. Yulaf lapası" />
          </div>
          <div>
            <label for="plan-meal-amount">Miktar/Detay</label>
            <input id="plan-meal-amount" placeholder="Ör. 60 g yulaf + 200 ml süt" />
          </div>
        </div>
        <div class="grid-2">
          <div>
            <label for="plan-meal-type">Öğün</label>
            <select id="plan-meal-type">
              <option value="sabah">Sabah</option>
              <option value="oglen">Öğle</option>
              <option value="aksam">Akşam</option>
            </select>
          </div>
          <div>
            <label for="plan-meal-order">Sıra (opsiyonel)</label>
            <input id="plan-meal-order" type="number" min="1" placeholder="Ör. 1" />
          </div>
        </div>
        <div class="actions">
          <button class="primary" id="add-plan-meal">Satır Ekle</button>
        </div>
        <div class="list" id="plan-meals-sabah-wrap">
          <div class="muted" style="margin-bottom:6px">Sabah</div>
          <div id="plan-meals-sabah"></div>
        </div>
        <div class="list" id="plan-meals-oglen-wrap" style="margin-top:10px">
          <div class="muted" style="margin-bottom:6px">Öğle</div>
          <div id="plan-meals-oglen"></div>
        </div>
        <div class="list" id="plan-meals-aksam-wrap" style="margin-top:10px">
          <div class="muted" style="margin-bottom:6px">Akşam</div>
          <div id="plan-meals-aksam"></div>
        </div>
      </div>

      <div class="card" id="fixed-workout-plan">
        <div class="section-title">
          <h3>Spor Programım (Sabit)</h3>
          <span class="pill" style="background:#2e1065; color:#c4b5fd; border:1px solid #4c1d95">PLAN</span>
        </div>
        <div class="grid-2">
          <div>
            <label for="plan-order">Sıra No</label>
            <input id="plan-order" type="number" min="1" placeholder="Ör. 1" />
          </div>
          <div>
            <label for="plan-ex-name">Egzersiz İsmi</label>
            <input id="plan-ex-name" placeholder="Ör. Bench Press" />
          </div>
        </div>
        <div class="grid-2">
          <div>
            <label for="plan-sets">Set</label>
            <input id="plan-sets" placeholder="Ör. 4" />
          </div>
          <div>
            <label for="plan-reps">Tekrar</label>
            <input id="plan-reps" placeholder="Ör. 8-10" />
          </div>
        </div>
        <div class="grid-2">
          <div>
            <label for="plan-tempo">Tempo Süresi</label>
            <input id="plan-tempo" placeholder="Ör. 3-1-1" />
          </div>
          <div>
            <label for="plan-reverse">Reps in Reverse</label>
            <input id="plan-reverse" placeholder="Ör. 10-8-6" />
          </div>
        </div>
        <label for="plan-note">Not</label>
        <input id="plan-note" placeholder="Ör. Omuz koru, son sette drop-set" />
        <div class="actions">
          <button class="primary" id="add-plan-ex">Egzersiz Ekle</button>
        </div>
        <div class="list" id="plan-workouts-list"></div>
      </div>
    </div>

    <div class="card" id="notes-card" style="margin-top:16px">
      <div class="section-title">
        <h3>Dikkat Edilecekler (Sabit Notlar)</h3>
        <span class="pill" style="background:#1e293b; color:#cbd5e1; border:1px solid #334155">SABİT</span>
      </div>
      <label for="pin-notes">Notlar (her zaman görünür)</label>
      <textarea id="pin-notes" placeholder="Ör. Şeker yok, günlük 2L su, omuz koruma"></textarea>
      <div class="muted" style="margin:6px 0 4px">Her satır ayrı bir madde olarak gösterilir.</div>
      <div id="pin-notes-preview" class="list" style="padding:8px 0"></div>
      <div class="actions">
        <button class="primary" id="save-notes">Notları Kaydet</button>
      </div>
    </div>
  </div>

  <script>
    // ------------------------
    // Yardımcılar
    // ------------------------
    const supabaseUrl = 'https://ccoxnqygctjmmfvsriwr.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjb3hucXlnY3RqbW1mdnNyaXdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4OTIxOTcsImV4cCI6MjA3MjQ2ODE5N30.CYjxTluCpRnQZxkupPFyJUB_smC6-KiDxNZwr6efOBU';
    let supabaseClient;
    function initSupabaseClient(){
      if (supabaseClient) return supabaseClient;
      if (window.supabase) {
        const cid = getClientId();
        supabaseClient = window.supabase.createClient(supabaseUrl, supabaseAnonKey, {
          global: { headers: { 'x-client-id': cid } }
        });
      }
      return supabaseClient;
    }

    const $ = (sel) => document.querySelector(sel);
    const todayISO = () => new Date().toISOString().slice(0,10);
    const pad = (n) => String(n).padStart(2,'0');
    const nowTime = () => { const d = new Date(); return `${pad(d.getHours())}:${pad(d.getMinutes())}` };
    const getClientId = () => {
      const key = 'client_id';
      let cid = localStorage.getItem(key);
      if (!cid) { cid = crypto.randomUUID ? crypto.randomUUID() : (Math.random().toString(36).slice(2)+Date.now()); localStorage.setItem(key, cid); }
      return cid;
    };

    function detectMealType(hhmm){
      // hhmm -> 'HH:MM'
      const [h,m] = hhmm.split(':').map(Number);
      const minutes = h*60 + m;
      const inRange = (a,b) => minutes >= a && minutes < b;
      // 09:00-12:00 => sabah
      if (inRange(9*60, 12*60)) return { key:'sabah', label:'SABAH', cls:'sabah' };
      // 12:00-18:30 => oglen
      if (inRange(12*60, 18*60 + 30)) return { key:'oglen', label:'ÖĞLE', cls:'oglen' };
      // 18:30-20:30 => aksam
      if (inRange(18*60 + 30, 20*60 + 30)) return { key:'aksam', label:'AKŞAM', cls:'aksam' };
      return { key:'diger', label:'DİĞER', cls:'ekstra' };
    }

    function setAutoTypePill(){
      const t = $('#time').value || nowTime();
      const mt = detectMealType(t);
      const pill = $('#autoMealType');
      pill.className = `pill ${mt.cls}`;
      pill.textContent = mt.label;
    }

    // ------------------------
    // UI Defaults
    // ------------------------
    (function initDefaults(){
      const d = $('#date');
      const t = $('#time');
      d.value = todayISO();
      t.value = nowTime();
      setAutoTypePill();
      initTheme();
    })();

    // ------------------------
    // Theme Management
    // ------------------------
    function initTheme(){
      const isLight = localStorage.getItem('theme') === 'light';
      if (isLight) setTheme('light');
    }

    function setTheme(theme){
      const isLight = theme === 'light';
      document.documentElement.className = isLight ? 'light' : '';
      document.body.className = isLight ? 'light' : '';
      const toggle = $('#theme-toggle');
      if (toggle) toggle.textContent = isLight ? '☀️' : '🌙';
      localStorage.setItem('theme', theme);
      // Apply theme classes to all elements
      document.querySelectorAll('.card, .item, input, select, textarea, button, .toast, .theme-toggle').forEach(el => {
        el.className = el.className.replace(/light/g, '').trim();
        if (isLight) el.className += ' light';
      });
    }

    $('#theme-toggle').addEventListener('click', () => {
      const isLight = document.documentElement.classList.contains('light');
      setTheme(isLight ? 'dark' : 'light');
    });

    // Supabase kütüphanesi yüklenince client'i oluştur ve günü yükle
    document.addEventListener('DOMContentLoaded', () => {
      initSupabaseClient();
      setTimeout(() => { loadDay(); if (typeof loadNotes === 'function') loadNotes(); if (typeof loadFixedPlans === 'function') loadFixedPlans(); renderNotesPreview(); }, 150);
    });

    $('#time').addEventListener('change', setAutoTypePill);
    document.addEventListener('input', (e) => { if (e.target && e.target.id === 'pin-notes') renderNotesPreview(); });

    // ------------------------
    // Toast System
    // ------------------------
    function showToast(message, type = 'success', undoAction = null){
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      if (document.documentElement.classList.contains('light')) toast.classList.add('light');
      
      const content = document.createElement('div');
      content.className = 'toast-content';
      content.innerHTML = `<span>${message}</span>`;
      
      if (undoAction) {
        const undoBtn = document.createElement('button');
        undoBtn.className = 'toast-undo';
        undoBtn.textContent = 'Geri Al';
        undoBtn.addEventListener('click', () => { undoAction(); toast.remove(); });
        content.appendChild(undoBtn);
      }
      
      toast.appendChild(content);
      document.body.appendChild(toast);
      
      setTimeout(() => toast.remove(), undoAction ? 5000 : 3000);
    }

    // ------------------------
    // SUPABASE Ops (tables must exist)
    // Tables: meal_entries(id, client_id, date, time, name, amount, meal_type)
    //         extra_entries(id, client_id, date, time, name, amount)
    //         workouts(id, client_id, date, time, name, reps, notes)
    // ------------------------
    async function supaInsert(table, row){
      if (!supabaseClient) initSupabaseClient();
      if (!supabaseClient) return { data:null, error: new Error('Supabase yok') };
      return await supabaseClient.from(table).insert(row).select();
    }

    async function supaSelect(table, filters){
      if (!supabaseClient) initSupabaseClient();
      if (!supabaseClient) return { data:[], error: new Error('Supabase yok') };
      let q = supabaseClient.from(table).select('*');
      Object.entries(filters).forEach(([k,v]) => { q = q.eq(k,v); });
      q = q.order('time', { ascending:true });
      return await q;
    }

    async function supaDeleteDay(date){
      if (!supabaseClient) initSupabaseClient();
      if (!supabaseClient) return;
      const cid = getClientId();
      await supabaseClient.from('meal_entries').delete().eq('client_id', cid).eq('date', date);
      await supabaseClient.from('extra_entries').delete().eq('client_id', cid).eq('date', date);
      await supabaseClient.from('workouts').delete().eq('client_id', cid).eq('date', date);
    }

    async function supaUpdate(table, id, fields){
      if (!supabaseClient) initSupabaseClient();
      if (!supabaseClient) return { error: new Error('Supabase yok') };
      return await supabaseClient.from(table).update(fields).eq('id', id);
    }

    async function supaDelete(table, id){
      if (!supabaseClient) initSupabaseClient();
      if (!supabaseClient) return { error: new Error('Supabase yok') };
      return await supabaseClient.from(table).delete().eq('id', id);
    }

    // Sabit Planlar: yükleme ve render
    async function loadFixedPlans(){
      if (!supabaseClient) initSupabaseClient();
      const cid = getClientId();
      const [pm, pw] = await Promise.all([
        supabaseClient.from('fixed_meal_plan').select('*').eq('client_id', cid).order('order_no', { ascending:true }).order('id', { ascending:true }),
        supabaseClient.from('fixed_workout_plan').select('*').eq('client_id', cid).order('order_no', { ascending:true }).order('id', { ascending:true }),
      ]);
      renderFixedMeals(pm.data || []);
      renderFixedWorkouts(pw.data || []);
    }

    function renderFixedMeals(items){
      const areas = {
        sabah: document.getElementById('plan-meals-sabah'),
        oglen: document.getElementById('plan-meals-oglen'),
        aksam: document.getElementById('plan-meals-aksam')
      };
      Object.values(areas).forEach(el => { if (el) el.innerHTML = ''; });
      if (!items.length){
        Object.values(areas).forEach(el => { if (el) el.innerHTML = '<div class="empty">Kayıt yok</div>'; });
        return;
      }
      items.forEach(it => {
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `<div><div style="font-weight:600">${it.name} <small>(${it.amount})</small></div></div>
                        <div class="item-actions">
                          <button class="btn-sm btn-ghost btn-edit" data-kind="plan-meal" data-id="${it.id}">Düzenle</button>
                          <button class="btn-sm btn-ghost btn-del" data-kind="plan-meal" data-id="${it.id}">Sil</button>
                        </div>`;
        const target = areas[it.meal_type] || areas.sabah;
        if (target) target.appendChild(el);
      });
    }

    function renderFixedWorkouts(items){
      const wrap = document.getElementById('plan-workouts-list');
      if (!wrap) return;
      wrap.innerHTML = '';
      if (!items.length){ wrap.innerHTML = '<div class="empty">Kayıt yok</div>'; return; }
      items.forEach(it => {
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `<div>
                          <div style="font-weight:600">#${it.order_no || ''} ${it.name}</div>
                          <small>Set: ${it.sets || ''} • Tekrar: ${it.reps || ''} • Tempo: ${it.tempo || ''} • Reverse: ${it.reverse_reps || ''}</small>
                          <div class="muted">${it.note || ''}</div>
                        </div>
                        <div class="item-actions">
                          <button class="btn-sm btn-ghost btn-edit" data-kind="plan-workout" data-id="${it.id}">Düzenle</button>
                          <button class="btn-sm btn-ghost btn-del" data-kind="plan-workout" data-id="${it.id}">Sil</button>
                        </div>`;
        wrap.appendChild(el);
      });
    }

    // Sabit Notlar (user_notes)
    async function loadNotes(){
      if (!supabaseClient) initSupabaseClient();
      const cid = getClientId();
      const { data } = await supabaseClient.from('user_notes').select('*').eq('client_id', cid).maybeSingle();
      if (data && $('#pin-notes')) { $('#pin-notes').value = data.content || ''; renderNotesPreview(); }
    }

    async function saveNotes(){
      if (!supabaseClient) initSupabaseClient();
      const cid = getClientId();
      const content = ($('#pin-notes') && $('#pin-notes').value) ? $('#pin-notes').value : '';
      await supabaseClient.from('user_notes').upsert({ client_id: cid, content }, { onConflict: 'client_id' });
    }

    function renderNotesPreview(){
      const preview = document.getElementById('pin-notes-preview');
      if (!preview) return;
      const content = ($('#pin-notes') && $('#pin-notes').value) ? $('#pin-notes').value : '';
      const lines = content.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      if (!lines.length){ preview.innerHTML = '<div class="empty">Madde bulunmuyor</div>'; return; }
      preview.innerHTML = '';
      lines.forEach(line => {
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `<div>• ${line}</div>`;
        preview.appendChild(el);
      });
    }

    // ------------------------
    // Render Helpers
    // ------------------------
    function renderMeals(meals){
      const wrap = $('#meals-list');
      wrap.innerHTML = '';
      if (!meals || meals.length === 0){ wrap.innerHTML = `<div class="empty">Kayıt yok</div>`; return; }
      meals.forEach(m => {
        const badge = { sabah:'sabah', oglen:'oglen', aksam:'aksam', diger:'ekstra' }[m.meal_type] || 'ekstra';
        const label = { sabah:'SABAH', oglen:'ÖĞLE', aksam:'AKŞAM', diger:'DİĞER' }[m.meal_type] || 'DİĞER';
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `<div><div style=\"font-weight:600\">${m.name} <small>(${m.amount})</small></div>
                         <small>${m.time}</small></div>
                         <div class=\"item-actions\">
                           <span class=\"pill ${badge}\" style=\"margin-right:6px\">${label}</span>
                           <button class=\"btn-sm btn-ghost btn-edit\" data-kind=\"meal\" data-id=\"${m.id}\">Düzenle</button>
                           <button class=\"btn-sm btn-ghost btn-del\" data-kind=\"meal\" data-id=\"${m.id}\">Sil</button>
                         </div>`;
        wrap.appendChild(el);
      });
    }

    function renderExtras(extras){
      const wrap = $('#extras-list');
      wrap.innerHTML = '';
      if (!extras || extras.length === 0){ wrap.innerHTML = `<div class="empty">Kayıt yok</div>`; return; }
      extras.forEach(x => {
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `<div><div style=\"font-weight:600\">${x.name} <small>(${x.amount})</small></div>
                         <small>${x.time}</small></div>
                         <div class=\"item-actions\">
                           <span class=\"pill ekstra\" style=\"margin-right:6px\">EKSTRA</span>
                           <button class=\"btn-sm btn-ghost btn-edit\" data-kind=\"extra\" data-id=\"${x.id}\">Düzenle</button>
                           <button class=\"btn-sm btn-ghost btn-del\" data-kind=\"extra\" data-id=\"${x.id}\">Sil</button>
                         </div>`;
        wrap.appendChild(el);
      });
    }

    function renderWorkouts(workouts){
      const wrap = $('#workouts-list');
      wrap.innerHTML = '';
      if (!workouts || workouts.length === 0){ wrap.innerHTML = `<div class="empty">Kayıt yok</div>`; return; }
      workouts.forEach(w => {
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `<div><div style=\"font-weight:600\">${w.name} <small>(${w.reps})</small></div>
                         <small>${w.time}</small><div class=\"muted\">${w.notes || ''}</div></div>
                         <div class=\"item-actions\">
                           <button class=\"btn-sm btn-ghost btn-edit\" data-kind=\"workout\" data-id=\"${w.id}\">Düzenle</button>
                           <button class=\"btn-sm btn-ghost btn-del\" data-kind=\"workout\" data-id=\"${w.id}\">Sil</button>
                         </div>`;
        wrap.appendChild(el);
      });
    }

    // ------------------------
    // Load Day
    // ------------------------
    async function loadDay(){
      const date = $('#date').value || todayISO();
      const cid = getClientId();
      const [mealsRes, extrasRes, workoutsRes] = await Promise.all([
        supaSelect('meal_entries', { client_id: cid, date }),
        supaSelect('extra_entries', { client_id: cid, date }),
        supaSelect('workouts', { client_id: cid, date }),
      ]);
      renderMeals(mealsRes.data || []);
      renderExtras(extrasRes.data || []);
      renderWorkouts(workoutsRes.data || []);
    }

    // Yedek: window load'ta da dene
    window.addEventListener('load', () => { initSupabaseClient(); setTimeout(() => { loadDay(); if (typeof loadNotes === 'function') loadNotes(); if (typeof loadFixedPlans === 'function') loadFixedPlans(); }, 150); });
    $('#date').addEventListener('change', () => { loadDay(); });

    // ------------------------
    // Add Handlers
    // ------------------------
    $('#add-meal').addEventListener('click', async () => {
      const name = $('#meal-name').value.trim();
      const amount = $('#meal-amount').value.trim();
      const date = $('#date').value || todayISO();
      const time = $('#time').value || nowTime();
      if (!name || !amount) return alert('Lütfen yemek ismi ve miktar giriniz.');
      const mt = detectMealType(time);
      const row = { client_id:getClientId(), date, time, name, amount, meal_type: mt.key };
      const { error } = await supaInsert('meal_entries', row);
      if (error) { showToast('Kaydetme hatası: ' + error.message, 'error'); return; }
      $('#meal-name').value = '';
      $('#meal-amount').value = '';
      showToast('Öğün kaydedildi', 'success');
      await loadDay();
    });

    $('#add-extra').addEventListener('click', async () => {
      const name = $('#extra-name').value.trim();
      const amount = $('#extra-amount').value.trim();
      const date = $('#date').value || todayISO();
      const time = $('#time').value || nowTime();
      if (!name || !amount) return alert('Lütfen ürün ve miktar giriniz.');
      const row = { client_id:getClientId(), date, time, name, amount };
      const { error } = await supaInsert('extra_entries', row);
      if (error) { showToast('Kaydetme hatası: ' + error.message, 'error'); return; }
      $('#extra-name').value = '';
      $('#extra-amount').value = '';
      showToast('Ekstra kaydedildi', 'success');
      await loadDay();
    });

    $('#add-workout').addEventListener('click', async () => {
      const name = $('#workout-name').value.trim();
      const reps = $('#workout-reps').value.trim();
      const notes = $('#workout-notes').value.trim();
      const date = $('#date').value || todayISO();
      const time = $('#time').value || nowTime();
      if (!name || !reps) return alert('Lütfen hareket ve tekrar/süre giriniz.');
      const row = { client_id:getClientId(), date, time, name, reps, notes };
      const { error } = await supaInsert('workouts', row);
      if (error) { showToast('Kaydetme hatası: ' + error.message, 'error'); return; }
      $('#workout-name').value = '';
      $('#workout-reps').value = '';
      $('#workout-notes').value = '';
      showToast('Spor kaydedildi', 'success');
      await loadDay();
    });

    // Sabit plan ekleme
    document.getElementById('add-plan-meal')?.addEventListener('click', async () => {
      if (!supabaseClient) initSupabaseClient();
      const cid = getClientId();
      const name = (document.getElementById('plan-meal-name')?.value || '').trim();
      const amount = (document.getElementById('plan-meal-amount')?.value || '').trim();
      const meal_type = (document.getElementById('plan-meal-type')?.value || 'sabah');
      const order_no = Number(document.getElementById('plan-meal-order')?.value || '');
      if (!name || !amount) return alert('Lütfen yemek ve miktar/detay giriniz.');
      const row = { client_id: cid, name, amount, meal_type };
      if (!Number.isNaN(order_no)) row.order_no = order_no;
      const { error } = await supabaseClient.from('fixed_meal_plan').insert(row).select();
      if (error) return showToast('Plan kaydetme hatası: ' + error.message, 'error');
      document.getElementById('plan-meal-name').value = '';
      document.getElementById('plan-meal-amount').value = '';
      const tSel = document.getElementById('plan-meal-type'); if (tSel) tSel.value = 'sabah';
      const oInp = document.getElementById('plan-meal-order'); if (oInp) oInp.value = '';
      showToast('Beslenme planı eklendi', 'success');
      await loadFixedPlans();
    });

    document.getElementById('add-plan-ex')?.addEventListener('click', async () => {
      if (!supabaseClient) initSupabaseClient();
      const cid = getClientId();
      const order_no = Number(document.getElementById('plan-order')?.value || '');
      const name = (document.getElementById('plan-ex-name')?.value || '').trim();
      const sets = (document.getElementById('plan-sets')?.value || '').trim();
      const reps = (document.getElementById('plan-reps')?.value || '').trim();
      const tempo = (document.getElementById('plan-tempo')?.value || '').trim();
      const reverse_reps = (document.getElementById('plan-reverse')?.value || '').trim();
      const note = (document.getElementById('plan-note')?.value || '').trim();
      if (!name) return alert('Lütfen egzersiz ismini giriniz.');
      const row = { client_id: cid, name, sets, reps, tempo, reverse_reps, note };
      if (!Number.isNaN(order_no)) row.order_no = order_no;
      const { error } = await supabaseClient.from('fixed_workout_plan').insert(row).select();
      if (error) return showToast('Plan kaydetme hatası: ' + error.message, 'error');
      ['plan-order','plan-ex-name','plan-sets','plan-reps','plan-tempo','plan-reverse','plan-note'].forEach(id=>{ const el=document.getElementById(id); if (el) el.value=''; });
      showToast('Spor planı eklendi', 'success');
      await loadFixedPlans();
    });

    // Listelerde düzenle/sil (event delegation)
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const kind = btn.dataset.kind;
      const id = btn.dataset.id;
      if (btn.id === 'save-notes'){
        try { await saveNotes(); showToast('Notlar kaydedildi', 'success'); } catch(err){ showToast('Not kaydetme hatası', 'error'); }
        return;
      }
      if (!kind || !id) return;

      if (btn.classList.contains('btn-del')){
        if (!confirm('Bu kaydı silmek istiyor musunuz?')) return;
        
        // Store item for undo
        let deletedItem = null;
        const table =
          kind === 'meal' ? 'meal_entries' :
          kind === 'extra' ? 'extra_entries' :
          kind === 'workout' ? 'workouts' :
          kind === 'plan-meal' ? 'fixed_meal_plan' :
          'fixed_workout_plan';
        
        // Get item data before deletion for undo
        if (supabaseClient) {
          const { data } = await supabaseClient.from(table).select('*').eq('id', id).single();
          if (data) deletedItem = { table, data };
        }
        
        const { error } = await supaDelete(table, id);
        if (error) { showToast('Silme hatası: ' + error.message, 'error'); return; }
        
        // Show undo toast
        showToast('Kayıt silindi', 'success', async () => {
          if (deletedItem) {
            const { error: undoError } = await supaInsert(deletedItem.table, deletedItem.data);
            if (undoError) showToast('Geri alma hatası', 'error');
            else showToast('Kayıt geri alındı', 'success');
            if (kind.startsWith('plan-')) await loadFixedPlans(); else await loadDay();
          }
        });
        
        if (kind.startsWith('plan-')) await loadFixedPlans(); else await loadDay();
        return;
      }

      if (btn.classList.contains('btn-edit')){
        if (kind === 'meal'){
          const name = prompt('Yemek ismi:'); if (name === null) return;
          const amount = prompt('Miktar:'); if (amount === null) return;
          const { error } = await supaUpdate('meal_entries', id, { name, amount });
          if (error) { showToast('Düzenleme hatası: ' + error.message, 'error'); return; }
        } else if (kind === 'extra'){
          const name = prompt('Ürün/İçecek:'); if (name === null) return;
          const amount = prompt('Miktar:'); if (amount === null) return;
          const { error } = await supaUpdate('extra_entries', id, { name, amount });
          if (error) { showToast('Düzenleme hatası: ' + error.message, 'error'); return; }
        } else if (kind === 'workout'){
          const name = prompt('Hareket:'); if (name === null) return;
          const reps = prompt('Süre/Tekrar:'); if (reps === null) return;
          const notes = prompt('Not (boş bırakılabilir):'); if (notes === null) return;
          const { error } = await supaUpdate('workouts', id, { name, reps, notes });
          if (error) { showToast('Düzenleme hatası: ' + error.message, 'error'); return; }
        } else if (kind === 'plan-meal'){
          const name = prompt('Yemek/Öğe:'); if (name === null) return;
          const amount = prompt('Miktar/Detay:'); if (amount === null) return;
          const meal_type = prompt('Öğün (sabah/oglen/aksam):', 'sabah'); if (meal_type === null) return;
          const order_no = prompt('Sıra (opsiyonel, sayı):');
          const fields = { name, amount, meal_type };
          if (order_no && !Number.isNaN(Number(order_no))) fields.order_no = Number(order_no);
          const { error } = await supaUpdate('fixed_meal_plan', id, fields);
          if (error) { showToast('Düzenleme hatası: ' + error.message, 'error'); return; }
        } else if (kind === 'plan-workout'){
          const order_no = prompt('Sıra No:'); if (order_no === null) return;
          const name = prompt('Egzersiz İsmi:'); if (name === null) return;
          const sets = prompt('Set:'); if (sets === null) return;
          const reps = prompt('Tekrar:'); if (reps === null) return;
          const tempo = prompt('Tempo Süresi:'); if (tempo === null) return;
          const reverse_reps = prompt('Reps in Reverse:'); if (reverse_reps === null) return;
          const note = prompt('Not:'); if (note === null) return;
          const fields = { name, sets, reps, tempo, reverse_reps, note };
          if (!Number.isNaN(Number(order_no))) fields.order_no = Number(order_no);
          const { error } = await supaUpdate('fixed_workout_plan', id, fields);
          if (error) { showToast('Düzenleme hatası: ' + error.message, 'error'); return; }
        }
        if (kind.startsWith('plan-')) await loadFixedPlans(); else await loadDay();
      }
    });

    // ------------------------
    // Clear Day
    // ------------------------
    $('#clear-day').addEventListener('click', async () => {
      const date = $('#date').value || todayISO();
      if (!confirm(`${date} tarihli tüm kayıtlar silinsin mi?`)) return;
      await supaDeleteDay(date);
      await loadDay();
    });

    // ------------------------
    // PDF Export (jsPDF + autoTable)
    // ------------------------
    $('#export-pdf').addEventListener('click', async () => {
      const date = $('#date').value || todayISO();
      const notes = ($('#pin-notes') && $('#pin-notes').value) ? $('#pin-notes').value : '';
      const cid = getClientId();
      const [mealsRes, extrasRes, workoutsRes] = await Promise.all([
        supaSelect('meal_entries', { client_id: cid, date }),
        supaSelect('extra_entries', { client_id: cid, date }),
        supaSelect('workouts', { client_id: cid, date }),
      ]);
      const meals = mealsRes.data || [];
      const extras = extrasRes.data || [];
      const workouts = workoutsRes.data || [];

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'a4' });
      const trToAscii = (s) => (s||'')
        .replace(/ç/g,'c').replace(/ğ/g,'g').replace(/ı/g,'i').replace(/i̇/g,'i')
        .replace(/ö/g,'o').replace(/ş/g,'s').replace(/ü/g,'u')
        .replace(/Ç/g,'C').replace(/Ğ/g,'G').replace(/İ/g,'I').replace(/İ/g,'I')
        .replace(/Ö/g,'O').replace(/Ş/g,'S').replace(/Ü/g,'U');
      const left = 40;
      let y = 40;
      doc.setFont('helvetica','bold'); doc.setFontSize(16);
      if (doc.setCharSpace) try { doc.setCharSpace(0); } catch(_){}
      doc.text(trToAscii(`Günlük Rapor - ${date}`), left, y);
      y += 20;
      doc.setFont('helvetica','normal'); doc.setTextColor(120);
      doc.text(trToAscii('Beslenme ve Spor Günlüğü'), left, y);
      doc.setTextColor(0);
      y += 24;

      if (notes){
        doc.setFont('helvetica','bold'); doc.setFontSize(12);
        doc.text(trToAscii('Dikkat Edilecekler'), left, y);
        y += 8;
        doc.setFont('helvetica','normal'); doc.setFontSize(10);
        const lines = notes.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        lines.forEach(line => {
          const wrapped = doc.splitTextToSize('• ' + trToAscii(line), 515);
          doc.text(wrapped, left, y);
          y += (wrapped.length * 12);
        });
        y += 8;
      }

      // Meals grouped
      const mealMap = { sabah:[], oglen:[], aksam:[], diger:[] };
      meals.forEach(m => mealMap[m.meal_type || 'diger'].push(m));
      const sections = [
        ['SABAH (09:00-12:00)', mealMap.sabah],
        ['OGLE (12:00-18:30)', mealMap.oglen],
        ['AKSAM (18:30-20:30)', mealMap.aksam],
        ['DIGER', mealMap.diger],
      ];

      sections.forEach(([title, arr]) => {
        if (!arr || arr.length === 0) return;
        doc.setFont('helvetica','bold'); doc.setFontSize(12);
        doc.text(trToAscii(title), left, y);
        y += 8;
        doc.autoTable({
          startY: y,
          head:[[trToAscii('Saat'), trToAscii('Yemek'), trToAscii('Miktar')]],
          body: arr.map(m => [m.time, trToAscii(m.name), trToAscii(m.amount)]),
          theme:'grid', styles:{ fontSize:10 }, margin:{ left }, headStyles:{ fillColor:[34,197,94] }
        });
        y = doc.lastAutoTable.finalY + 14;
      });

      if (extras.length){
        doc.setFont('helvetica','bold'); doc.setFontSize(12);
        doc.text('EKSTRA', left, y);
        y += 8;
        doc.autoTable({ startY:y, head:[[trToAscii('Saat'), trToAscii('Urun'), trToAscii('Miktar')]], body: extras.map(x=>[x.time,trToAscii(x.name),trToAscii(x.amount)]), theme:'grid', styles:{ fontSize:10 }, margin:{ left }, headStyles:{ fillColor:[6,182,212] } });
        y = doc.lastAutoTable.finalY + 14;
      }

      if (workouts.length){
        doc.setFont('helvetica','bold'); doc.setFontSize(12);
        doc.text('SPOR', left, y);
        y += 8;
        doc.autoTable({ startY:y, head:[[trToAscii('Saat'), trToAscii('Hareket'), trToAscii('Tekrar/Sure'), trToAscii('Not')]], body: workouts.map(w=>[w.time,trToAscii(w.name),trToAscii(w.reps),trToAscii(w.notes||'')]), theme:'grid', styles:{ fontSize:10 }, margin:{ left }, headStyles:{ fillColor:[168,85,247] } });
      }

      doc.save(`gunluk-rapor-${date}.pdf`);
    });
  </script>
</body>
</html>


